{% extends 'base.html' %}

{% block title %}患者对话界面 | TransMbD{% endblock %}

{% block page_title %}
    {% if patient %}
    与 {{ patient.name }} 的对话
    {% else %}
    患者对话界面
    {% endif %}
{% endblock %}

{% block page_actions %}
{% if patient %}
<div class="patient-info-badge">
    <span class="patient-avatar">{{ patient.name.0 }}</span>
    <div class="patient-details">
        <div class="patient-name">{{ patient.name }}</div>
        <div class="patient-id">ID: {{ patient.patient_id }}</div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow mb-4 chat-card">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-comments me-2"></i>
                    {% if patient %}
                    与 {{ patient.name }} 的对话
                    {% else %}
                    模拟对话
                    {% endif %}
                </h6>
                {% if patient %}
                <div class="dropdown no-arrow">
                    <a class="dropdown-toggle" href="#" role="button" id="patientMenuLink" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end shadow patient-menu">
                        <div class="dropdown-header">患者信息:</div>
                        <div class="patient-info-item">
                            <i class="fas fa-user fa-sm fa-fw me-2 text-gray-400"></i>
                            ID: {{ patient.patient_id }}
                        </div>
                        <div class="patient-info-item">
                            <i class="fas fa-calendar fa-sm fa-fw me-2 text-gray-400"></i>
                            年龄: {{ patient.age }}
                        </div>
                        <div class="dropdown-divider"></div>
                        <div class="patient-info-item">
                            <i class="fas fa-brain fa-sm fa-fw me-2 text-gray-400"></i>
                            MMSE: {% if patient.mmse_score %}{{ patient.mmse_score }}{% else %}未记录{% endif %}
                        </div>
                        <div class="patient-info-item">
                            <i class="fas fa-chart-line fa-sm fa-fw me-2 text-gray-400"></i>
                            CDR: {% if patient.cdr_score %}{{ patient.cdr_score }}{% else %}未记录{% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="card-body chat-body">
                <div id="chat-container" class="chat-container">
                    <!-- 初始系统消息 -->
                    <div class="message message-system">
                        <div class="message-header">
                            <span class="message-sender">系统</span>
                            <span class="message-time">{{ now|date:"H:i" }}</span>
                        </div>
                        <div class="message-content">
                            您好！我是您的数字助手。我们今天可以聊一聊您的情况和感受。请告诉我，您今天感觉如何？
                        </div>
                    </div>
                    <!-- 对话消息将在这里动态添加 -->
                </div>

                <div class="input-container mt-3">
                    <div class="input-group">
                        <input type="text" id="user-input" class="form-control chat-input" placeholder="请输入您的回复..." aria-label="请输入您的回复">
                        <button class="btn btn-primary chat-send" type="button" id="send-button">
                            <i class="fas fa-paper-plane"></i> 发送
                        </button>
                    </div>

                    <div class="chat-actions mt-3">
                        <button class="btn btn-outline-secondary chat-voice" id="voice-input-button">
                            <i class="fas fa-microphone"></i> 语音输入
                        </button>
                        <button class="btn btn-outline-danger chat-end" id="end-conversation-button">
                            <i class="fas fa-stop-circle"></i> 结束对话
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-light py-2">
                <div class="typing-status" id="typing-status">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span class="typing-text">系统正在输入...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 语音输入模态框 -->
<div class="modal fade" id="voiceInputModal" tabindex="-1" aria-labelledby="voiceInputModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="voiceInputModalLabel">
                    <i class="fas fa-microphone me-2"></i> 语音输入
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="recording-indicator" class="mb-3 d-none">
                    <div class="record-animation">
                        <div class="record-circle"></div>
                        <div class="record-circle"></div>
                        <div class="record-circle"></div>
                    </div>
                    <p class="mt-2">正在录音，请说话...</p>
                </div>
                <div id="processing-indicator" class="mb-3 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">处理中...</span>
                    </div>
                    <p class="mt-2">正在处理您的语音...</p>
                </div>
                <div id="result-container" class="mb-3 d-none">
                    <div class="alert alert-success">
                        <p class="mb-0"><strong>识别结果:</strong></p>
                        <p id="voice-result" class="mb-0"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="start-recording-button">
                    <i class="fas fa-microphone"></i> 开始录音
                </button>
                <button type="button" class="btn btn-warning d-none" id="stop-recording-button">
                    <i class="fas fa-stop"></i> 停止录音
                </button>
                <button type="button" class="btn btn-primary d-none" id="use-voice-result-button">
                    使用该结果
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // 对话功能代码保持不变，仅优化界面交互...
    });
</script>

<style>
    /* 患者界面特定样式 */
    .chat-card {
        border-radius: 1rem;
        overflow: hidden;
    }
    
    .chat-body {
        padding: 1.5rem;
        background-color: #f8f9fc;
    }
    
    .chat-container {
        height: 400px;
        padding: 1rem;
        background-color: white;
        border-radius: 0.5rem;
        border: 1px solid #e3e6f0;
        box-shadow: var(--shadow-sm);
    }
    
    .message {
        margin-bottom: 1.5rem;
        padding: 1rem;
        border-radius: 1rem;
        max-width: 80%;
        position: relative;
    }
    
    .message-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.8rem;
    }
    
    .message-sender {
        font-weight: 600;
    }
    
    .message-time {
        color: var(--secondary-color);
    }
    
    .message-content {
        line-height: 1.5;
    }
    
    .message-patient {
        background-color: #d1e7ff;
        margin-left: auto;
        text-align: right;
        border-bottom-right-radius: 0.25rem;
    }
    
    .message-system {
        background-color: white;
        margin-right: auto;
        border-bottom-left-radius: 0.25rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .chat-input {
        border-radius: 2rem;
        padding-left: 1rem;
        border: 1px solid #d1d3e2;
    }
    
    .chat-send {
        border-radius: 0 2rem 2rem 0;
        padding-left: 1.25rem;
        padding-right: 1.25rem;
    }
    
    .chat-actions {
        display: flex;
        justify-content: center;
        gap: 1rem;
    }
    
    .chat-voice, .chat-end {
        border-radius: 2rem;
        padding-left: 1.25rem;
        padding-right: 1.25rem;
    }
    
    .typing-status {
        display: none;
        align-items: center;
        color: var(--secondary-color);
        font-size: 0.9rem;
    }
    
    .typing-indicator {
        display: inline-flex;
        margin-right: 0.5rem;
    }
    
    .typing-indicator span {
        width: 0.5rem;
        height: 0.5rem;
        margin: 0 1px;
        background-color: var(--secondary-color);
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out both;
    }
    
    .typing-indicator span:nth-child(1) {
        animation-delay: 0s;
    }
    
    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typing {
        0%, 80%, 100% { 
            transform: scale(0.6);
            opacity: 0.6;
        }
        40% { 
            transform: scale(1);
            opacity: 1;
        }
    }
    
    .record-animation {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 60px;
    }
    
    .record-circle {
        width: 12px;
        height: 12px;
        margin: 0 4px;
        border-radius: 50%;
        background-color: #e74a3b;
        animation: record 1.5s infinite ease-in-out both;
    }
    
    .record-circle:nth-child(1) {
        animation-delay: 0s;
    }
    
    .record-circle:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .record-circle:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes record {
        0%, 80%, 100% { 
            transform: scale(0.7);
        }
        40% { 
            transform: scale(1.2);
        }
    }
    
    .patient-info-badge {
        display: flex;
        align-items: center;
        background-color: white;
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        box-shadow: var(--shadow-sm);
    }
    
    .patient-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: var(--success-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 0.75rem;
    }
    
    .patient-name {
        font-weight: 600;
    }
    
    .patient-id {
        font-size: 0.8rem;
        color: var(--secondary-color);
    }
    
    .patient-menu {
        min-width: 220px;
    }
    
    .patient-info-item {
        padding: 0.5rem 1.5rem;
        color: var(--dark-color);
    }
</style>
{% endblock %}